name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag-and-release:
    runs-on: ubuntu-latest

    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 2

        - name: Get version
          id: current
          run: |
            VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
            echo "version=$VERSION"

        - name: Get previous version
          id: previous
          run: |
            git checkout HEAD~1
            VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
            echo "version=$VERSION"
            git checkout -

        - name: Check if version changed
          id: changed
          run: |
            if [ "${{ steps.current.outputs.version }}" = "${{ steps.previous.outputs.version }}" ]; then
              echo "changed=false"
            else
              echo "changed=true"
            fi

        - name: Create tag
          if: steps.changed.outputs.changed == 'true'
          run: |
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git tag v${{ steps.current.outputs.version }}
            git push origin v${{ steps.current.outputs.version }}

        - name: Create Release
          if: steps.changed.outputs.changed == 'true'
          uses: softprops/action-gh-release@v2
          with:
            tag_name: v${{ steps.current.outputs.version }}
            name: Release v${{ steps.current.outputs.version }}
